<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nuguna.freview.store.mapper.StoreActivityPageMapper">

  <resultMap id="StoreActivityPageSendLikeResultMap"
    type="com.nuguna.freview.store.dto.response.StoreActivitySendLikeResponseDTO">
    <result property="writtenSeq" column="post_author_seq"/>
    <result property="postSeq" column="post_seq"/>
    <result property="title" column="post_title"/>
    <result property="content" column="post_content"/>
    <result property="likeCount" column="like_count"/>
    <result property="createdAt" column="like_created_at"/>
  </resultMap>

  <resultMap id="StoreActivityPageSendZzimResultMap"
    type="com.nuguna.freview.store.dto.response.StoreActivitySendZzimResponseDTO">
    <result property="userSeq" column="from_user_seq"/>
    <result property="toUserSeq" column="to_user_seq"/>
    <result property="nickname" column="nickname"/>
    <result property="code" column="code"/>
    <result property="zzimCount" column="zzimCount"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <resultMap id="StoreActivityPageWrittenPostResultMap"
    type="com.nuguna.freview.store.dto.response.StoreActivityWrittenPostResponseDTO">
    <result property="postSeq" column="seq"/>
    <result property="userSeq" column="user_seq"/>
    <result property="title" column="title"/>
    <result property="content" column="content"/>
    <result property="experienceDate" column="experience_date"/>
    <result property="createdAt" column="created_at"/>
    <result property="likeCount" column="likeCount"/>
  </resultMap>

  <resultMap id="StoreActivityPageWrittenReplyResultMap"
    type="com.nuguna.freview.store.dto.response.StoreActivityWrittenReplyResponseDTO">
    <result property="userSeq" column="user_seq"/>
    <result property="postSeq" column="post_seq"/>
    <result property="title" column="post_title"/>
    <result property="content" column="reply_content"/>
    <result property="createdAt" column="reply_created_at"/>
  </resultMap>

  <select id="storeActivityPageSendLike" resultMap="StoreActivityPageSendLikeResultMap ">
    SELECT p.seq         AS post_seq,
           p.title       AS post_title,
           p.content     AS post_content,
           u.seq         AS post_author_seq,
           l.created_at  AS like_created_at,
           COUNT(lk.seq) AS like_count
    FROM `like` l
           JOIN `post` p ON l.post_seq = p.seq
           JOIN `user` u ON p.user_seq = u.seq
           LEFT JOIN `like` lk ON p.seq = lk.post_seq
    WHERE l.user_seq = #{userSeq}
    GROUP BY l.seq, p.seq
  </select>

  <select id="storeActivityPageSendZzim" resultMap="StoreActivityPageSendZzimResultMap">
    SELECT u.nickname,
           u.code,
           zz.from_user_seq,
           zz.to_user_seq,
           zz.created_at,
           IFNULL(zzc.zzimCount, 0) AS zzimCount
    FROM `user` u
           JOIN (SELECT z.from_user_seq, z.to_user_seq, z.created_at
                 FROM ZZIM z
                 WHERE z.from_user_seq = #{userSeq}) zz ON u.seq = zz.to_user_seq
           LEFT JOIN (SELECT to_user_seq, COUNT(*) AS zzimCount
                      FROM ZZIM
                      GROUP BY to_user_seq) zzc ON u.seq = zzc.to_user_seq
  </select>

  <select id="storeActivityPageWrittenPost" resultMap="StoreActivityPageWrittenPostResultMap">
    SELECT p.seq,
           p.user_seq,
           p.title,
           p.content,
           p.experience_date,
           p.created_at,
           COUNT(l.post_seq) AS likeCount
    FROM post p
           LEFT JOIN `like` l ON l.post_seq = p.seq
    WHERE p.user_seq = #{userSeq}
    GROUP BY p.seq, p.title, p.content, p.experience_date, p.created_at
  </select>

  <select id="storeActivityPageWrittenReply" resultMap="StoreActivityPageWrittenReplyResultMap">
    SELECT r.seq AS user_seq,
           r.content AS reply_content,
           r.created_at AS reply_created_at,
           p.seq AS post_seq,
           p.title AS post_title
    FROM `reply` r
           JOIN `post` p ON r.post_seq = p.seq
    WHERE r.user_seq = 1
  </select>

</mapper>
