<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nuguna.freview.store.mapper.StoreExperiencePageMapper">
  <resultMap id="getStoreApplyListResultMap" type="com.nuguna.freview.store.dto.response.StoreApplyListDTO" >
    <result property="fromPostSeq" column="from_post_seq" />
    <result property="fromUserSeq" column="from_user_seq" />
    <result property="toUserSeq" column="to_user_seq" />
    <result property="title" column="title" />
    <result property="status" column="status" />
    <result property="applyStartDate" column="apply_start_date" />
    <result property="applyEndDate" column="apply_end_date" />
    <result property="experienceDate" column="experience_date" />
    <result property="createdAt" column="created_at" />
  </resultMap>

  <resultMap id="getStoreProposalListResultMap" type="com.nuguna.freview.store.dto.response.StoreProposalListDTO">
    <result property="toUserSeq" column="to_user_seq" />
    <result property="proposalDetail" column="proposal_detail" />
    <result property="createdAt" column="created_at" />
    <result property="status" column="status" />
    <result property="nickname" column="nickname" />
  </resultMap>

  <!-- 확정 : 지원자 -->
  <resultMap id="getStoreFinalApplyListResultMap" type="com.nuguna.freview.store.dto.response.StoreFinalApplyListDTO">
    <result property="fromUserSeq" column="from_user_seq" />
    <result property="title" column="title" />
    <result property="nickname" column="nickname" />
    <result property="experienceDate" column="experience_date" />
    <result property="status" column="status" />
  </resultMap>
  <!-- 확정 : 제안자 -->
  <resultMap id="getStoreFinalProposalListResultMap" type="com.nuguna.freview.store.dto.response.StoreFinalProposalListDTO">
    <result property="toUserSeq" column="to_user_seq"/>
    <result property="proposalDetail" column="proposal_detail" />
    <result property="nickname" column="nickname" />
    <result property="experienceDate" column="experience_date" />
    <result property="status" column="status" />
  </resultMap>


  <!-- 리뷰 리스트 -->
  <resultMap id="getStoreReviewListResultMap" type="com.nuguna.freview.store.dto.response.StoreReviewListDTO">
    <result property="customerSeq" column="customer_seq" />
    <result property="experienceSeq" column="experience_seq" />
    <result property="nickname" column="nickname" />
    <result property="status" column="status" />
    <result property="url" column="url" />
    <result property="createdAt" column="created_at" />
  </resultMap>



  <select id="getStoreApplyCount" resultType="java.lang.Integer">
    select COUNT(*)
    FROM experience e
           INNER JOIN post p
                      ON p.user_seq = e.to_user_seq
                        AND p.user_seq = #{userSeq}
    WHERE p.user_seq = e.to_user_seq
  </select>

  <select id="getStoreApplyList" resultMap="getStoreApplyListResultMap">
    SELECT e.from_user_seq, e.to_user_seq, e.from_post_seq, e.`status`, e.created_at,
           p.apply_start_date, p.apply_end_date, p.experience_date,
           p.title
    FROM experience e
           INNER JOIN post p
               ON p.user_seq = e.to_user_seq
                 AND p.user_seq = #{userSeq}
    WHERE p.user_seq = e.to_user_seq
    LIMIT #{pageSize}
    OFFSET #{offset}
  </select>
  <update id="setStoreApplyStatus">
    update experience
        set status = 'ACCEPTED'
        where seq = #{experienceSeq}
  </update>


  <select id="getStoreProposalList" resultMap="getStoreProposalListResultMap">
    SELECT e.to_user_seq, e.proposal_detail, e.created_at, e.`status`, u.nickname
    FROM experience e
           INNER JOIN `user` u ON u.seq = e.to_user_seq
    WHERE e.from_user_seq = #{userSeq}
    LIMIT #{pageSize}
      OFFSET #{offset}
  </select>
  <select id="getStoreProposalListCount" resultType="java.lang.Integer">
    select COUNT(*)
    FROM experience e
           INNER JOIN `user` u ON u.seq = e.to_user_seq
    WHERE e.from_user_seq = #{userSeq}
  </select>

  <!--  확정 - 지원자 -->
  <select id="getStoreFinalApplyList" resultMap="getStoreFinalApplyListResultMap">
    SELECT p.title, p.experience_date, e.from_user_seq, u.nickname, e.`status`
    FROM experience e
           INNER JOIN post p ON p.seq = e.from_post_seq
           INNER JOIN `user` u ON u.seq = e.from_user_seq
    WHERE e.to_user_seq = #{userSeq}
  </select>
  <select id="getStoreFinalApplyListCount" resultType="java.lang.Integer">
    SELECT COUNT(*)
    FROM experience e
           INNER JOIN post p ON p.seq = e.from_post_seq
           INNER JOIN `user` u ON u.seq = e.from_user_seq
    WHERE e.to_user_seq = #{userSeq}
  </select>

  <!-- 확정 - 제안자 -->
  <select id="getStoreFinalProposalList" resultMap="getStoreFinalProposalListResultMap">
    SELECT e.to_user_seq, e.proposal_detail, e.`status`, p.experience_date, u.nickname
    FROM experience e
           INNER JOIN post p ON p.user_seq = e.from_user_seq
           INNER JOIN `user` u ON u.seq = e.to_user_seq
    WHERE e.from_user_seq = #{userSeq}
    LIMIT ${pageSize}
    OFFSET #{offset}
  </select>
  <select id="getStoreFinalProposalListCount" resultType="java.lang.Integer">
    SELECT COUNT(*)
    FROM experience e
           INNER JOIN post p ON p.user_seq = e.from_user_seq
           INNER JOIN `user` u ON u.seq = e.to_user_seq
    WHERE e.from_user_seq = #{userSeq}
  </select>

  <update id="setUpdateExperienceDate">
    update experience
    set confirm_date = sysdate()
    where seq = #{experienceSeq}
  </update>

  <update id="setUpdateExperienceStatus">
    update experience
    set status = #{status}
    where seq = #{experienceSeq}
  </update>


  <select id="getStoreReviewList" resultMap="getStoreReviewListResultMap">
    SELECT u.nickname, r.customer_seq, r.experience_seq, r.`status`, r.url
    FROM review r
           INNER JOIN `user` u ON u.seq = r.customer_seq
    WHERE r.store_seq = #{userSeq}
    LIMIT #{pageSize}
    OFFSET #{offset}
  </select>
  <select id="getStoreReviewListCount" resultType="java.lang.Integer">
    SELECT COUNT(*)
    FROM review r
           INNER JOIN `user` u ON u.seq = r.customer_seq
    WHERE r.store_seq = #{userSeq}
  </select>

  <update id="setUpdateReviewStatus">
    update review
    set status = #{status}
    where customer_seq = #{customerSeq}
  </update>

</mapper>