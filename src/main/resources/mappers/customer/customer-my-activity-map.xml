<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nuguna.freview.customer.mapper.CustomerMyActivityMapper">

  <select id="getLikesCount" resultType="java.lang.Integer">
    select count(*)
    from `like`
    where user_seq = #{userSeq}
  </select>


  <resultMap id="MyLikePostInfoDTOResultMap"
    type="com.nuguna.freview.customer.dto.response.MyLikePostInfoDTO">
    <id property="seq" column="seq"/>
    <result property="authorSeq" column="user_seq"/>
    <result property="title" column="title"/>
    <result property="content" column="content"/>
    <result property="createdAt" column="created_at"/>
    <result property="storeName" column="store_name"/>
    <result property="likeCount" column="likeCount"/>
  </resultMap>

  <select id="getMyLikedPosts" resultMap="MyLikePostInfoDTOResultMap">
    WITH like_post AS (SELECT l.user_seq,
                              l.post_seq,
                              l.created_at,
                              ROW_NUMBER() OVER (ORDER BY l.created_at DESC) AS row_num
                       FROM `like` l
                       WHERE l.post_seq IN (SELECT ll.post_seq
                                            FROM `like` ll
                                            WHERE ll.user_seq = #{userSeq})),
         filtered_like_post AS (SELECT *
                                FROM like_post
                                WHERE row_num &gt; #{offset}
                                  AND row_num &lt;= #{offset} + #{pageSize})

    SELECT like_post_info.*,
           (SELECT count(*) FROM `like` WHERE post_seq = like_post_info.seq) AS likeCount
    FROM (SELECT p.seq,
                 p.user_seq,
                 p.title,
                 p.content,
                 flp.created_at,
                 nsbi.store_name
          FROM post p
                 INNER JOIN filtered_like_post flp ON p.seq = flp.post_seq
                 LEFT JOIN user u ON p.user_seq = u.seq
                 INNER JOIN national_store_business_information nsbi
                            ON u.business_number = nsbi.business_number) AS like_post_info
  </select>

</mapper>